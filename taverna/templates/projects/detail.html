{% extends "homepage.html" %}

{% block titulo %}{{ project.titulo }}{% endblock %}

{% block body %}
{% include "navbar.html" %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind_fallback.css') }}">
<div class="max-w-5xl mx-auto px-4 md:px-6 py-6 md:py-10">
  <!-- Breadcrumb -->
  <nav class="text-sm text-gray-500 mb-4" aria-label="Breadcrumb">
    <a href="{{ url_for('feed') }}" class="hover:underline">Feed</a>
    <span class="mx-2">/</span>
    <span class="text-gray-700" aria-current="page">{{ project.titulo }}</span>
  </nav>

  <!-- T칤tulo -->
  <header class="mb-6">
    <h1 class="text-3xl md:text-4xl font-bold text-gray-900">{{ project.titulo }}</h1>
  </header>

  <!-- Grid principal -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8">
    <!-- Coluna Conte칰do (lg:2) -->
    <section class="lg:col-span-2 space-y-6">
      <!-- Galeria -->
      {% if project.midias %}
      <div class="bg-white rounded-2xl shadow p-4">
        <ul class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          {% for m in project.midias %}
          {% set ext = m.nome_arquivo.split('.')[-1].lower() %}
          {% set icones = {
            'pdf': 'lontra-pdf.png',
            'doc': 'lontra-docx.png',
            'docx': 'lontra-docx.png',
            'ppt': 'lontra-croft.png',
            'pptx': 'lontra-croft.png',
            'csv': 'lontra-csv.png',
            'xlsx': 'lontra-xlsx.png'
          } %}
          {% if ext in ['jpg', 'jpeg', 'png'] %}
          <li>
            <button type="button" class="group w-full rounded-xl overflow-hidden shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" data-modal-image="{{ url_for('static', filename='projetos_midias/' ~ m.nome_arquivo) }}" aria-label="Ver m칤dia">
              <img src="{{ url_for('static', filename='projetos_midias/' ~ m.nome_arquivo) }}" alt="M칤dia do projeto" class="w-full h-52 object-cover group-hover:scale-[1.02] transition-all">
            </button>
          </li>
          {% elif ext == 'mp4' %}
          <li>
            <video controls class="w-full h-52 object-cover rounded-xl">
              <source src="{{ url_for('static', filename='projetos_midias/' ~ m.nome_arquivo) }}" type="video/mp4">
            </video>
          </li>
          {% else %}
          {% set icone = icones.get(ext, 'lontra-croft.png') %}
          <li>
            <div class="flex flex-col items-center justify-center p-4 border rounded-xl">
              <img src="{{ url_for('static', filename='fotos_site/' ~ icone) }}" class="w-20 h-20 object-contain mb-2" alt="Arquivo {{ m.nome_arquivo }}">
              <a href="{{ url_for('static', filename='projetos_midias/' ~ m.nome_arquivo) }}" target="_blank" class="text-sm text-indigo-600 hover:underline">{{ m.nome_arquivo }}</a>
            </div>
          </li>
          {% endif %}
          {% endfor %}
        </ul>
      </div>
      {% endif %}

      <!-- Descri칞칚o/Conte칰do -->
      <article class="bg-white rounded-2xl shadow p-6 prose prose-indigo max-w-none">
        <h2 class="text-xl font-semibold mb-3">Descri칞칚o</h2>
        <p class="!my-0 text-gray-700">{{ project.descricao or 'Sem descri칞칚o.' }}</p>

        {% if project.conteudo %}
        <hr class="my-5">
        <h3 class="text-lg font-semibold">Conte칰do</h3>
        <div class="text-gray-800 whitespace-pre-line">{{ project.conteudo }}</div>
        {% endif %}
      </article>

      <!-- Coment치rios -->
      <section class="bg-white rounded-2xl shadow">
        <header class="border-b px-6 py-4 flex items-center gap-2">
          <span aria-hidden="true">游눫</span>
          <h2 class="text-lg font-semibold">Coment치rios</h2>
          <span class="ml-auto text-sm text-gray-500">{{ comments|length }} coment치rio(s)</span>
        </header>

        <div class="p-6 space-y-4">
          {% if comments %}
            <ul class="space-y-4">
              {% for c in comments %}
              <li class="flex gap-3">
                <img src="{{ url_for('static', filename='avatares/' ~ (c.usuario.avatar or 'default.png')) }}" class="w-10 h-10 rounded-full" alt="Avatar">
                <div class="flex-1">
                  <div class="flex items-center gap-2">
                    <strong class="text-gray-900">{{ c.usuario.username }}</strong>
                    <span class="text-xs text-gray-500">{{ c.data_criacao.strftime('%d/%m/%Y %H:%M') }}</span>
                  </div>
                  <p class="text-gray-800">{{ c.texto }}</p>
                </div>
              </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="text-center text-gray-500">Nenhum coment치rio ainda.</div>
          {% endif %}

          <!-- Formul치rio -->
          <form method="POST" action="{{ url_for('visualizar_projeto', id_projeto=project.id) }}" class="space-y-3">
            {{ form.csrf_token }}
            <label class="sr-only" for="comment">Deixe seu coment치rio</label>
            <textarea id="comment" name="texto" rows="3" class="w-full rounded-xl border px-3 py-2 focus:ring-2 focus:ring-indigo-500" placeholder="Deixe seu coment치rio..."></textarea>
            <div class="flex justify-end">
              <button type="submit" class="rounded-xl bg-indigo-600 text-white px-4 py-2 disabled:opacity-50" disabled id="btn-comment">Comentar</button>
            </div>
          </form>
        </div>
      </section>
    </section>

    <!-- Coluna Metadados -->
    <aside class="lg:col-span-1 space-y-6">
      <div class="bg-white rounded-2xl shadow p-5">
        <div class="flex items-center gap-3 mb-4">
          <img src="{{ url_for('static', filename='avatares/' ~ (project.autor.avatar or 'default.png')) }}" class="w-12 h-12 rounded-full" alt="Avatar do autor">
          <div>
            <div class="text-sm text-gray-500">Autor</div>
            <div class="font-medium text-gray-900">{{ project.autor.username }}</div>
          </div>
        </div>

        <dl class="space-y-3 text-sm">
          <div class="flex justify-between">
            <dt class="text-gray-500">Categoria</dt>
            <dd><span class="inline-flex items-center rounded-full bg-indigo-50 text-indigo-700 px-2 py-0.5">{{ project.categoria }}</span></dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-gray-500">Ano Escolar</dt>
            <dd><span class="inline-flex items-center rounded-full bg-amber-50 text-amber-700 px-2 py-0.5">{{ project.ano_escolar }}</span></dd>
          </div>
          {% if project.tags %}
          <div>
            <dt class="text-gray-500 mb-1">Tags</dt>
            <dd class="flex flex-wrap gap-2">
              {% for t in project.tags.split(',') %}
              <span class="inline-flex items-center rounded-full border px-2 py-0.5 text-xs">#{{ t.strip() }}</span>
              {% endfor %}
            </dd>
          </div>
          {% endif %}
        </dl>

        <div class="mt-5 flex gap-2">
          <a href="{{ url_for('novo_projeto') }}" class="flex-1 rounded-xl border px-3 py-2 text-center hover:bg-gray-50">Editar</a>
          <button type="button" class="flex-1 rounded-xl bg-rose-600 text-white px-3 py-2 hover:bg-rose-700" data-open="delete-modal">Excluir</button>
        </div>
      </div>

      <!-- Action bar sticky (mobile) -->
      <div class="lg:hidden fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur border-t p-3 flex gap-2">
        <a href="{{ url_for('novo_projeto') }}" class="flex-1 rounded-xl border px-3 py-2 text-center">Editar</a>
        <button type="button" class="flex-1 rounded-xl bg-rose-600 text-white px-3 py-2" data-open="delete-modal">Excluir</button>
      </div>
    </aside>
  </div>
</div>

<!-- Modal excluir -->
<div id="delete-modal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="del-title">
  <div class="absolute inset-0 bg-black/40"></div>
  <div class="relative mx-auto mt-24 max-w-md bg-white rounded-2xl shadow p-6">
    <h3 id="del-title" class="text-lg font-semibold mb-2">Excluir projeto?</h3>
    <p class="text-sm text-gray-600 mb-4">Essa a칞칚o n칚o pode ser desfeita.</p>
    <form method="POST" action="{{ url_for('deletar_projeto', id_projeto=project.id) }}" class="flex gap-2 justify-end">
      {{ form.csrf_token }}
      <button type="button" class="rounded-xl border px-4 py-2" data-close="delete-modal">Cancelar</button>
      <button type="submit" class="rounded-xl bg-rose-600 text-white px-4 py-2">Excluir</button>
    </form>
  </div>
</div>

<!-- Lightbox simples -->
<div id="lightbox" class="fixed inset-0 z-40 hidden items-center justify-center bg-black/70" role="dialog" aria-modal="true">
  <img id="lightbox-img" src="" alt="M칤dia ampliada" class="max-h-full max-w-full rounded-xl">
</div>

<script>
  // Enable/disable bot칚o comentar
  const textarea = document.getElementById('comment');
  const btn = document.getElementById('btn-comment');
  if (textarea && btn) {
    textarea.addEventListener('input', () => {
      btn.disabled = textarea.value.trim().length < 2;
    });
  }
  // Modal excluir
  const openers = document.querySelectorAll('[data-open="delete-modal"]');
  const closers = document.querySelectorAll('[data-close="delete-modal"]');
  const modal = document.getElementById('delete-modal');
  openers.forEach(o => o.addEventListener('click', ()=> modal.classList.remove('hidden')));
  closers.forEach(c => c.addEventListener('click', ()=> modal.classList.add('hidden')));
  modal?.addEventListener('click', (e)=>{ if(e.target===modal) modal.classList.add('hidden'); });

  // Lightbox
  const lb = document.getElementById('lightbox');
  const lbImg = document.getElementById('lightbox-img');
  document.querySelectorAll('[data-modal-image]').forEach(btn => {
    btn.addEventListener('click', () => {
      lbImg.src = btn.getAttribute('data-modal-image');
      lb.classList.remove('hidden');
    });
  });
  lb.addEventListener('click', () => lb.classList.add('hidden'));
</script>
{% endblock %}
