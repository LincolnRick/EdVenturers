{% extends "homepage.html" %}

{% block titulo %}{{ project.titulo }}{% endblock %}

{% block body %}
{% include "navbar.html" %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind_fallback.css') }}">
<style>
  .max-w-6xl{max-width:72rem;margin-left:auto;margin-right:auto;}
  .text-gray-400{color:#9ca3af;}
  .bg-gray-100{background-color:#f3f4f6;}
  .mx-2{margin-left:0.5rem;margin-right:0.5rem;}
  .divide-y > :not(:last-child){border-bottom:1px solid #e5e7eb;}
  .rounded{border-radius:0.25rem;}
  .w-9{width:2.25rem;}
  .h-9{height:2.25rem;}
  .flex-wrap{flex-wrap:wrap;}
  .border-b{border-bottom:1px solid #e5e7eb;}
  .text-xs{font-size:0.75rem;}
  .bg-black\/40{background-color:rgba(0,0,0,0.4);}
  @media(min-width:1024px){
    .lg\:col-span-2{grid-column:span 2/span 2;}
    .lg\:col-span-1{grid-column:span 1/span 1;}
    .lg\:hidden{display:none;}
  }
</style>
<div class="max-w-6xl mx-auto px-4 md:px-6 py-6 md:py-10">
  <!-- Breadcrumb -->
  <nav class="text-sm text-gray-500 mb-3" aria-label="breadcrumb">
    <a href="{{ url_for('feed') }}" class="hover:underline">Feed</a>
    <span class="mx-2 text-gray-400">‚Ä∫</span>
    <span class="text-gray-700" aria-current="page">{{ project.titulo }}</span>
  </nav>

  <!-- T√≠tulo -->
  <header class="mb-6">
    <h1 class="text-3xl md:text-4xl font-bold text-gray-900">{{ project.titulo }}</h1>
  </header>

  <!-- GRID PRINCIPAL -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8">
    <!-- COLUNA ESQUERDA (conte√∫do) -->
    <section class="lg:col-span-2 space-y-6">

      {# M√çDIA VISUAL #}
      {% if visual_media|length > 0 %}
        {% include 'partials/carousel.html' %}
      {% endif %}

      {# √ÅUDIOS E ANEXOS #}
      {% set ns = namespace(audios=[], outros=[]) %}
      {% for a in attachments %}
        {% if a.mime_type and a.mime_type.startswith('audio/') %}
          {% set _ = ns.audios.append(a) %}
        {% else %}
          {% set _ = ns.outros.append(a) %}
        {% endif %}
      {% endfor %}

      {% if ns.audios %}
        <section class="bg-white rounded-2xl shadow p-6">
          <h2 class="text-lg font-semibold mb-3">√Åudios</h2>
          <ul class="space-y-4">
            {% for a in ns.audios %}
              {% set src = url_for('static', filename=a.filepath) if a.filepath and not a.filepath.startswith('http') else a.filepath %}
              <li>
                <audio controls class="w-full">
                  <source src="{{ src }}" type="{{ a.mime_type }}">
                  Seu navegador n√£o suporta √°udio. <a href="{{ src }}" target="_blank" rel="noopener">Ouvir √°udio</a>
                </audio>
                <div class="text-xs text-gray-500 mt-1">{{ a.original_name or a.alt }}</div>
              </li>
            {% endfor %}
          </ul>
        </section>
      {% endif %}

      {% if ns.outros %}
        {% set attachments = ns.outros %}
        {% include 'partials/attachments.html' %}
      {% endif %}

      <!-- DESCRI√á√ÉO / CONTE√öDO -->
      <article class="bg-white rounded-2xl shadow p-6 prose prose-indigo max-w-none">
        <h2 class="text-xl font-semibold mb-3">Descri√ß√£o</h2>
        <p class="!my-0 text-gray-700">{{ project.descricao or 'Sem descri√ß√£o.' }}</p>

        {% if project.conteudo %}
        <hr class="my-5">
        <h3 class="text-lg font-semibold">Conte√∫do</h3>
        <div class="text-gray-800 whitespace-pre-line">{{ project.conteudo }}</div>
        {% endif %}
      </article>

      <!-- COMENT√ÅRIOS -->
      <section class="bg-white rounded-2xl shadow overflow-hidden">
        <header class="border-b px-6 py-4 flex items-center gap-2">
          <span aria-hidden="true">üí¨</span>
          <h2 class="text-lg font-semibold">Coment√°rios</h2>
          <span class="ml-auto text-sm text-gray-500">{{ comments|length }} coment√°rio(s)</span>
        </header>
        <div class="p-6 space-y-4">
          {% if comments %}
            <ul class="space-y-4">
              {% for c in comments %}
              <li class="flex gap-3">
                <img src="{{ url_for('static', filename='avatares/' ~ (c.usuario.avatar or 'default.png')) }}" class="w-10 h-10 rounded-full" alt="Avatar de {{ c.usuario.username }}">
                <div class="flex-1">
                  <div class="flex items-center gap-2">
                    <strong class="text-gray-900">{{ c.usuario.username }}</strong>
                    <span class="text-xs text-gray-500">{{ c.data_criacao.strftime('%d/%m/%Y %H:%M') }}</span>
                  </div>
                  <p class="text-gray-800">{{ c.texto }}</p>
                </div>
              </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="text-center text-gray-500">Nenhum coment√°rio ainda.</div>
          {% endif %}

          <form method="POST" action="{{ url_for('visualizar_projeto', id_projeto=project.id) }}" class="space-y-3">
            {{ form.csrf_token }}
            <label class="sr-only" for="comment">Deixe seu coment√°rio</label>
            <textarea id="comment" name="texto" rows="3" class="w-full rounded-xl border px-3 py-2 focus:ring-2 focus:ring-indigo-500" placeholder="Deixe seu coment√°rio..."></textarea>
            <div class="flex justify-end">
              <button type="submit" class="rounded-xl bg-indigo-600 text-white px-4 py-2 disabled:opacity-50" disabled id="btn-comment">Comentar</button>
            </div>
          </form>
        </div>
      </section>

    </section>

    <!-- COLUNA DIREITA (metadados + a√ß√µes) -->
    <aside class="lg:col-span-1 space-y-6">
      <div class="bg-white rounded-2xl shadow p-5">
        <div class="flex items-center gap-3 mb-4">
          <img src="{{ url_for('static', filename='avatares/' ~ (project.autor.avatar or 'default.png')) }}" class="w-12 h-12 rounded-full" alt="Avatar do autor">
          <div>
            <div class="text-sm text-gray-500">Autor</div>
            <div class="font-medium text-gray-900">{{ project.autor.username }}</div>
          </div>
        </div>

        <dl class="space-y-3 text-sm">
          <div class="flex justify-between">
            <dt class="text-gray-500">Categoria</dt>
            <dd><span class="inline-flex items-center rounded-full bg-indigo-50 text-indigo-700 px-2 py-0.5">{{ project.categoria }}</span></dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-gray-500">Ano Escolar</dt>
            <dd><span class="inline-flex items-center rounded-full bg-amber-50 text-amber-700 px-2 py-0.5">{{ project.ano_escolar }}</span></dd>
          </div>
          {% if project.tags %}
          <div>
            <dt class="text-gray-500 mb-1">Tags</dt>
            <dd class="flex flex-wrap gap-2">
              {% for t in project.tags.split(',') %}
              <span class="inline-flex items-center rounded-full border px-2 py-0.5 text-xs">#{{ t.strip() }}</span>
              {% endfor %}
            </dd>
          </div>
          {% endif %}
        </dl>
        <div class="mt-5">
          <button id="like-btn" data-project-id="{{ project.id }}" data-auth="{{ 'true' if current_user.is_authenticated else 'false' }}"
                  class="w-full flex items-center justify-center gap-1 rounded-xl border px-3 py-2 hover:bg-gray-50">
            <svg class="w-5 h-5 {{ 'text-red-500' if liked else 'text-gray-500' }}"
                 viewBox="0 0 24 24" fill="{{ 'currentColor' if liked else 'none' }}" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 8.25c0-2.485-2.131-4.5-4.76-4.5-1.688 0-3.24.86-4.24 2.22-1-1.36-2.552-2.22-4.24-2.22C3.131 3.75 1 5.765 1 8.25c0 7.056 8.25 11.25 11 11.25 2.75 0 11-4.194 11-11.25z" /></svg>
            <span id="like-count">{{ like_count }}</span>
          </button>
        </div>

        {% if current_user.is_authenticated and current_user.id == project.autor.id %}
        <div class="mt-5 flex gap-2">
          <a href="{{ url_for('editar_projeto', id_projeto=project.id) }}" class="flex-1 rounded-xl border px-3 py-2 text-center hover:bg-gray-50">Editar</a>
          <button type="button" class="flex-1 rounded-xl bg-rose-600 text-white px-3 py-2 hover:bg-rose-700" data-open="delete-modal">Excluir</button>
        </div>
        {% endif %}
      </div>

      {% if current_user.is_authenticated and current_user.id == project.autor.id %}
      <!-- Action bar sticky (mobile) -->
      <div class="lg:hidden fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur border-t p-3 flex gap-2">
        <a href="{{ url_for('editar_projeto', id_projeto=project.id) }}" class="flex-1 rounded-xl border px-3 py-2 text-center">Editar</a>
        <button type="button" class="flex-1 rounded-xl bg-rose-600 text-white px-3 py-2" data-open="delete-modal">Excluir</button>
      </div>
      {% endif %}
    </aside>
  </div>
</div>

<!-- Modal excluir -->
<div id="delete-modal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="del-title">
  <div class="absolute inset-0 bg-black/40" data-close="delete-modal"></div>
  <div class="relative mx-auto mt-24 max-w-md bg-white rounded-2xl shadow p-6">
    <h3 id="del-title" class="text-lg font-semibold mb-2">Excluir projeto?</h3>
    <p class="text-sm text-gray-600 mb-4">Essa a√ß√£o n√£o pode ser desfeita.</p>
    <form method="POST" action="{{ url_for('deletar_projeto', id_projeto=project.id) }}" class="flex gap-2 justify-end">
      {{ form.csrf_token }}
      <button type="button" class="rounded-xl border px-4 py-2" data-close="delete-modal">Cancelar</button>
      <button type="submit" class="rounded-xl bg-rose-600 text-white px-4 py-2">Excluir</button>
    </form>
  </div>
</div>

<script>
  // Habilitar bot√£o "Comentar" s√≥ quando h√° texto
  (function(){
    const ta = document.getElementById('comment');
    const btn = document.getElementById('btn-comment');
    if (ta && btn) {
      const sync = ()=> btn.disabled = ta.value.trim().length < 2;
      ta.addEventListener('input', sync); sync();
    }
  })();
  // Modal excluir
  (function(){
    const modal = document.getElementById('delete-modal');
    document.querySelectorAll('[data-open="delete-modal"]').forEach(b => b.addEventListener('click', ()=> modal.classList.remove('hidden')));
    document.querySelectorAll('[data-close="delete-modal"]').forEach(b => b.addEventListener('click', ()=> modal.classList.add('hidden')));
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') modal.classList.add('hidden'); });
    modal?.addEventListener('click', (e)=>{ if(e.target.classList.contains('bg-black/40')) modal.classList.add('hidden'); });
  })();
  // Curtidas
  (function(){
    const btn = document.getElementById('like-btn');
    if(btn){
      btn.addEventListener('click', async () => {
        const auth = btn.dataset.auth === 'true';
        if(!auth){
          window.location.href = "{{ url_for('homepage') }}";
          return;
        }
        const id = btn.dataset.projectId;
        try{
          const resp = await fetch(`/projetos/${id}/curtir`, {method:'POST'});
          if(!resp.ok) return;
          const data = await resp.json();
          document.getElementById('like-count').textContent = data.count;
          const svg = btn.querySelector('svg');
          if(data.liked){
            svg.setAttribute('fill','currentColor');
            svg.classList.add('text-red-500');
          }else{
            svg.setAttribute('fill','none');
            svg.classList.remove('text-red-500');
          }
        }catch(e){console.error(e);}
      });
    }
  })();
</script>
{% endblock %}
