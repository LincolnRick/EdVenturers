{% extends "homepage.html" %}

{% block titulo %}
Feed da Taverna
{% endblock %}

{% block body %}
<body>
  {% include "navbar.html" %}

  <section class="container">
    <h1>Feed principal</h1>

    {% include "partials/filter_bar.html" %}

    <!-- Lista de projetos -->
    <div class="linha-feed">
      {% for projeto in projetos %}
        <div class="card-feed">
          <h2>{{ projeto.titulo }}</h2>
          <p><strong>Autor:</strong>
            <a href="{{ url_for('perfil', id_usuario=projeto.autor.id) }}">{{ projeto.autor.username }}</a>
            <span class="badge-nivel">Lv {{ niveis_autores[projeto.autor.id] }}</span>
          </p>
          <p><strong>Descrição:</strong> {{ projeto.descricao }}</p>

          <div class="tags">
            <span class="tag-item">{{ projeto.categoria }}</span>
            <span class="tag-item">{{ projeto.ano_escolar }}</span>
            {% if projeto.tags %}
              {% for tag in projeto.tags.split(',') %}
                <span class="tag-item">{{ tag.strip() }}</span>
              {% endfor %}
            {% endif %}
          </div>

          <p><a href="{{ url_for('visualizar_projeto', id_projeto=projeto.id) }}">Ver projeto completo</a></p>

          <!-- Mídias vinculadas -->
          {% if projeto.midias %}
            {% set f = projeto.midias[0] %}
            {% set extensao = f.nome_arquivo.split('.')[-1].lower() %}
            {% set icones = {
              'pdf': 'lontra-pdf.png',
              'doc': 'lontra-docx.png',
              'docx': 'lontra-docx.png',
              'ppt': 'lontra-croft.png',
              'pptx': 'lontra-croft.png',
              'csv': 'lontra-csv.png',
              'xlsx': 'lontra-xlsx.png'
            } %}
            {% set icone = icones.get(extensao, 'lontra-croft.png') %}

            {% if extensao in ['jpg', 'jpeg', 'png'] %}
              <img src="{{ url_for('static', filename='projetos_midias/' ~ f.nome_arquivo) }}" class="imagem-feed" alt="Mídia do projeto {{ projeto.titulo }}">
            {% elif extensao == 'mp4' %}
              <video controls class="imagem-feed">
                <source src="{{ url_for('static', filename='projetos_midias/' ~ f.nome_arquivo) }}" type="video/mp4">
              </video>
            {% else %}
              <div class="arquivo-generico">
                <img src="{{ url_for('static', filename='fotos_site/' ~ icone) }}" class="imagem-feed" alt="Arquivo {{ f.nome_arquivo }}">
                <a href="{{ url_for('static', filename='projetos_midias/' ~ f.nome_arquivo) }}" target="_blank">
                  {{ f.nome_arquivo }}
                </a>
              </div>
            {% endif %}
          {% endif %}
        </div>
      {% else %}
        <p>Nenhum projeto encontrado.</p>
      {% endfor %}
    </div>

    {% if pagination and pagination.pages > 1 %}
      <div class="paginacao">
        {% if pagination.has_prev %}
          <a href="{{ url_for('feed', page=pagination.prev_num, **request.args.to_dict(flat=False)) }}">Anterior</a>
        {% endif %}
        <span>Página {{ pagination.page }} de {{ pagination.pages }}</span>
        {% if pagination.has_next %}
          <a href="{{ url_for('feed', page=pagination.next_num, **request.args.to_dict(flat=False)) }}">Próxima</a>
        {% endif %}
      </div>
    {% endif %}
  </section>

  <script>
  (function(){
    const form = document.getElementById('filter-form');
    const hidden = document.getElementById('hidden-fields');
    const chips = document.querySelectorAll('.chip-btn');

    function rebuildHidden(){
      hidden.innerHTML = '';
      document.querySelectorAll('.chip-active').forEach(ch => {
        const name = ch.dataset.name;
        const value = ch.dataset.value;
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = name;   // múltiplos valores -> getlist()
        input.value = value;
        hidden.appendChild(input);
      });
    }

    chips.forEach(chip => {
      chip.addEventListener('click', () => {
        chip.classList.toggle('chip-active');
        chip.classList.toggle('chip');
        rebuildHidden();
      });
    });

    // Autocomplete de usuários
    const search = document.getElementById('user-search');
    const box = document.getElementById('user-suggestions');
    let timer;

    function renderSuggestions(items){
      if (!items.length){ box.classList.add('hidden'); return; }
      box.innerHTML = items.map(u => `
        <button type="button" class="w-full text-left px-3 py-2 hover:bg-gray-100"
                data-name="${u.name}" data-email="${u.email}">
          <div class="font-medium">${u.name}</div>
          <div class="text-xs text-gray-500">${u.email}</div>
        </button>
      `).join('');
      box.classList.remove('hidden');

      box.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => {
          search.value = btn.dataset.name;
          box.classList.add('hidden');
        });
      });
    }

    async function fetchUsers(q){
      try{
        const r = await fetch(`/api/users/search?q=${encodeURIComponent(q)}`);
        if(!r.ok) return renderSuggestions([]);
        const data = await r.json();
        renderSuggestions(data.results || []);
      }catch(e){ renderSuggestions([]); }
    }

    search.addEventListener('input', () => {
      clearTimeout(timer);
      const q = search.value.trim();
      if (q.length < 2){ box.classList.add('hidden'); return; }
      timer = setTimeout(() => fetchUsers(q), 180);
    });

    rebuildHidden();
  })();
  </script>
</body>
{% endblock %}
