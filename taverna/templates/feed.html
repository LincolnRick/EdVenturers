{% extends "homepage.html" %}

{% block titulo %}Feed principal{% endblock %}

{% block body %}
<body>
  {% include "navbar.html" %}

<div class="max-w-6xl mx-auto px-4 md:px-6 py-8">
  <header class="text-center mb-6">
    <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Feed principal</h1>
    <p class="text-sm text-gray-600 mt-1">Descubra projetos e filtre por anos, categorias, tags e perfis.</p>
  </header>

  <!-- Barra de ordena√ß√£o (preserva filtros) -->
  <form id="sort-form" method="GET" action="{{ url_for('feed') }}" class="flex items-center justify-end gap-2 mb-3">
    {% for y in request.args.getlist('year') %}<input type="hidden" name="year" value="{{ y }}">{% endfor %}
    {% for c in request.args.getlist('category') %}<input type="hidden" name="category" value="{{ c }}">{% endfor %}
    {% for t in request.args.getlist('tag') %}<input type="hidden" name="tag" value="{{ t }}">{% endfor %}
    {% if request.args.get('q_user') %}<input type="hidden" name="q_user" value="{{ request.args.get('q_user') }}">{% endif %}
    <label for="sort" class="text-sm text-gray-600">Ordenar por</label>
    <select id="sort" name="sort" class="rounded-xl border px-3 py-1.5 text-sm" onchange="this.form.submit()">
      <option value="new" {{ 'selected' if sort=='new' }}>Mais recentes</option>
      <option value="old" {{ 'selected' if sort=='old' }}>Mais antigos</option>
      <option value="comments" {{ 'selected' if sort=='comments' }}>Mais comentados</option>
      <option value="rating" {{ 'selected' if sort=='rating' }}>Melhor avaliados</option>
    </select>
  </form>

  <!-- Filter Bar central -->
  <div class="bg-white rounded-2xl shadow p-4 md:p-6">
    <form id="filter-form" method="GET" action="{{ url_for('feed') }}" class="space-y-4">
      <!-- busca de perfis -->
      <div class="flex flex-col md:flex-row md:items-center gap-3">
        <label class="text-sm font-medium text-gray-700 shrink-0" for="user-search">Buscar perfis</label>
        <div class="relative w-full">
          <input id="user-search" name="q_user" type="text" placeholder="Digite nome ou e-mail"
                 class="w-full rounded-xl border px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                 autocomplete="off" value="{{ request.args.get('q_user','') }}">
          <div id="user-suggestions"
               class="absolute z-20 mt-1 w-full rounded-xl border bg-white shadow hidden max-h-60 overflow-auto"></div>
        </div>
      </div>

      <!-- chips -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- anos -->
        <div>
          <div class="text-sm font-semibold mb-2">Anos Escolares em Destaque</div>
          <div class="flex flex-wrap gap-2">
            {% for year in years %}
              {% set active = year|string in request.args.getlist('year') %}
              <button type="button" class="chip-btn {{ 'chip-active' if active else 'chip' }}" data-name="year" data-value="{{ year }}">{{ year }}</button>
            {% endfor %}
          </div>
        </div>
        <!-- categorias -->
        <div>
          <div class="text-sm font-semibold mb-2">Categorias Populares</div>
          <div class="flex flex-wrap gap-2">
            {% for c in categories %}
              {% set active = c.slug in request.args.getlist('category') %}
              <button type="button" class="chip-btn {{ 'chip-active' if active else 'chip' }}" data-name="category" data-value="{{ c.slug }}">{{ c.name }}</button>
            {% endfor %}
          </div>
        </div>
        <!-- tags -->
        <div>
          <div class="text-sm font-semibold mb-2">Tags em Alta</div>
          <div class="flex flex-wrap gap-2">
            {% for t in tags %}
              {% set active = t.slug in request.args.getlist('tag') %}
              <button type="button" class="chip-btn {{ 'chip-active' if active else 'chip' }}" data-name="tag" data-value="{{ t.slug }}">#{{ t.name }}</button>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- filtros ativos -->
      <div id="active-filters" class="flex flex-wrap items-center gap-2">
        <!-- preenchido via JS a partir dos chips ativos -->
      </div>

      <!-- hidden inputs din√¢micos -->
      <div id="hidden-fields"></div>

      <div class="flex items-center justify-between">
        <span class="text-xs text-gray-500">Dica: combine v√°rios filtros ao mesmo tempo.</span>
        <div class="flex gap-2">
          <a href="{{ url_for('feed') }}" class="rounded-xl border px-4 py-2 text-sm">Limpar</a>
          <button type="submit" class="rounded-xl bg-indigo-600 text-white px-4 py-2 text-sm hover:bg-indigo-700">Aplicar filtros</button>
        </div>
      </div>
    </form>
  </div>

  <!-- estado vazio -->
  {% if not projects %}
    <div class="mt-8 rounded-2xl bg-white p-10 text-center shadow">
      <div class="text-4xl mb-2">üóÇÔ∏è</div>
      <h2 class="text-lg font-semibold">Nenhum projeto encontrado</h2>
      <p class="text-gray-600">Tente remover alguns filtros ou alterar a ordena√ß√£o.</p>
    </div>
  {% else %}

    <!-- skeleton -->
    <div id="feed-skeleton" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mt-6">
      {% for _ in range(6) %}<div class="animate-pulse bg-white rounded-2xl shadow p-4 h-64"></div>{% endfor %}
    </div>

    <!-- grid de cards -->
    <div id="feed-grid" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mt-6">
      {% for project in projects %}
        {% include 'partials/project_card.html' %}
      {% endfor %}
    </div>

    <!-- pagina√ß√£o -->
    <nav class="mt-8 flex justify-center" aria-label="Pagina√ß√£o">
      <ul class="inline-flex items-center gap-2">
        {% if pagination.has_prev %}
          <li><a class="rounded-xl border px-3 py-1.5 text-sm hover:bg-gray-50"
                 href="{{ url_for('feed', page=pagination.prev_num, sort=sort, **request.args.to_dict(flat=False)) }}">Anterior</a></li>
        {% endif %}
        <li class="text-sm text-gray-600">P√°gina {{ pagination.page }} de {{ pagination.pages }}</li>
        {% if pagination.has_next %}
          <li><a class="rounded-xl border px-3 py-1.5 text-sm hover:bg-gray-50"
                 href="{{ url_for('feed', page=pagination.next_num, sort=sort, **request.args.to_dict(flat=False)) }}">Pr√≥xima</a></li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}
</div>

<!-- estilos dos chips -->
<style>
  .chip{border-radius:9999px;border:1px solid #d1d5db;padding:0.25rem 0.75rem;font-size:0.875rem;transition:border-color .2s;}
  .chip:hover{border-color:#818cf8;}
  .chip-active{border-radius:9999px;background-color:#4f46e5;color:#fff;padding:0.25rem 0.75rem;font-size:0.875rem;}
</style>

</body>
{% endblock %}
